#meta
  %h1#title=h @topic.title

  - if logged_in?
    :javascript
      new Ajax.InPlaceEditor('title', '#{update_title_of_topic_path(@topic)}', { highlightendcolor: "#e5e5e5"});

  #taglist
    %h2 Tags
    %ul
      - @topic.tags.each do |tag|
        %li{ :id => "tag-#{tag.name.gsub(/\s/, "-")}" }
          = link_to_remote "[x]", :url => untag_topic_path(@topic, :tag => tag.name) if logged_in?
          = link_to h(tag.name), tag
    - if logged_in?
      - form_for(:tag, :url => tag_topic_path(@topic)) do |f|
        = f.text_field :name, :style => "width: 142px"
        = f.submit "add"

  #talking
    %h3
      Who's talking?
      %small (by time last seen)
    %ol
      - posters_by_latest(@topic.posts).each do |user, time|
        %li
          = time.to_formatted_s(:short)
          = link_to h(user.name), user

  - if admin?
    #admin
      %h2 Administrative
      %p Split topic with checked messages.

#posts
  - prevpost, showed_gravatar = nil
  - @topic.posts.each do |post|
    - user_continuation = (prevpost and prevpost.user == post.user)
    - showed_gravatar = false unless user_continuation
    %a{ :name => post.id }/
    .post
      .user
        - unless user_continuation
          = link_to h(shorten_username(post.user.name)), user_path(post.user)
        - if !showed_gravatar and post.body.length > 150
          = link_to image_tag(post.user.gravatar_url, :alt => "#{h post.user.name} gravatar"), user_path(post.user)
          - showed_gravatar = true

      - if admin?
        .mark<
          = check_box :post, :check3
      .time<
        = link_to('&nbsp;' + post.created_at.to_formatted_s(:short).gsub(' ', '&nbsp;'), topic_post_path(@topic, post))
      .body<
        = user_html(post.body)
    - prevpost = post

  - if logged_in?
    = render :partial => 'posts/slowreply'
    = render :partial => 'posts/quickreply'
